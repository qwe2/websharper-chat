(function(){var $$=this,$=this.IntelliFactory.Runtime,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;$.Define($$,{WebsharperChat:{ChatClient:{Append:function(y){var z;z=a.getElementById("chatbox").appendChild(y.Body).parentNode;b(z).scrollTop(b(z).height());return;},AppendUser:function(A){var B;B=e.LI(f.ofArray([e.Text(A)]));a.getElementById("userli").appendChild(B.Body);return;},Connect:function(C){return h.SetEventHandlers(new i(C));},HandleMessage:function(D){var E,F;if(D.$==0){return h.Append(h.RenderMsg(D.$0,D.$1));}else{if(D.$==2){return h.ShowUserList(h.RenderUserlist(D.$0));}else{if(D.$==3){if(D.$0){E=D.$1;h.Append(h.RenderInfo(E+" has connected"));return h.AppendUser(E);}else{F=D.$1;h.Append(h.RenderInfo(F+" has disconnected"));return h.RemoveUser(F);}}else{return h.Append(h.RenderError(D.$0));}}}},Main:function(G){var H,I,J;H=h.Connect("ws://"+j.location.host+"/chatsocket");I=e.Input(f.ofArray([e.Text(""),e.Attr().NewAttr("id","message-box"),e.Attr().Class("form-control col-md-12"),e.Attr().NewAttr("type","text")]));J=function(){return function(L){return L.CharacterCode===13?h.SendText(H,I):null;};};k.Events().OnKeyPress(J,I);return l.add(e.Div(f.ofArray([e.Attr().Class("container")])),f.ofArray([e.A(f.ofArray([e.Attr().NewAttr("href",G),e.Attr().Class("btn btn-primary"),e.Text("Log out")])),l.add(e.Div(f.ofArray([e.Attr().Class("row styled_container")])),f.ofArray([e.Div(f.ofArray([e.Attr().NewAttr("id","chatbox"),e.Attr().Class("col-md-10")])),e.Div(f.ofArray([e.Attr().NewAttr("id","userlist"),e.Attr().Class("col-md-2")]))])),l.add(e.Div(f.ofArray([e.Attr().Class("row")])),f.ofArray([I]))]));},RemoveUser:function(M){b("#userli").children().each(function(){var O;O=b(this);m.Log(O.text());return O.text()===M?void O.remove():null;});},RenderError:function(P){return e.P(f.ofArray([e.Text(P),e.Attr().Class("bg-danger")]));},RenderInfo:function(Q){return e.P(f.ofArray([e.Text(Q),e.Attr().Class("bg-warning")]));},RenderMsg:function(R,S){var T;T=f.ofArray([e.Text(R+": ")]);return l.add(e.P(f.ofArray([e.Tags().NewTag("strong",T)])),f.ofArray([e.Text(S),e.Attr().Class("bg-info")]));},RenderUserlist:function(U){return l.add(e.UL(f.ofArray([e.Attr().NewAttr("id","userli")])),n.map(function(V){return e.LI(f.ofArray([e.Text(V)]));},U));},SendText:function(W,X){var Y;Y=o.Trim(X.get_Value());if(Y!==""){W.send(Y);}return X.set_Value("");},SetEventHandlers:function(Z){Z.onmessage=function(_0){return h.HandleMessage(p.parse(q(_0.data)));};Z.onerror=function(){return h.Append(h.RenderError("Something went wrong."));};return Z;},ShowUserList:function(_2){var _3;_3=b("#userlist");_3.children().each(function(){b(this).remove();});_3.append(_2.Body);return;}},ChatControl:$.Class({get_Body:function(){return h.Main(this.logout);}}),ClAuth:{LoginForm:function(_5){var _6;_6=r.LoginPiglet();return t.Render(function(_7){return function(_8){return function(_9){return r.RenderLoginForm(_7,_8,_9);};};},t.Run($.Tupled(function(){j.location=_5;return _5;}),_6));},LoginPiglet:$.Field(function(){var ba;ba=t.WithSubmit(u.op_LessMultiplyGreater(u.op_LessMultiplyGreater(t.Return(function(bb){return function(bc){return[bb,bc];};}),v.Is(function(bc){return v.NotEmpty(bc);},"Enter Username",t.Yield(""))),v.Is(function(bd){return v.NotEmpty(bd);},"Enter password",t.Yield(""))));return v.Is($.Tupled(function(be){return w.Call("WebsharperChat:0",[be[0],be[1]]);}),"Invalid username or password.",ba);}),RenderLoginForm:function(bf,bg,bh){var bi,bl,bo,bq,br;bi=x.input("text",function(bj){return bj;},function(bk){return bk;},bf);bi["HtmlProvider@32"].AddClass(bi.Body,"form-control");bl=x.input("text",function(bm){return bm;},function(bn){return bn;},bg);bl["HtmlProvider@32"].AddClass(bl.Body,"form-control");bl["HtmlProvider@32"].SetAttribute(bl.Body,"type","password");bo=x.Submit(bh);bo["HtmlProvider@32"].AddClass(bo.Body,"btn btn-primary");b(bl.Body).keyup(function(bp){if(bp.which===13){bp.preventDefault();b(bo.Body).click();return;}else{return null;}});bq=f.ofArray([e.Attr().NewAttr("for",bi.get_Id()),e.Attr().Class("col-sm-2 control-label"),e.Text("Username")]);br=f.ofArray([e.Attr().NewAttr("for",bl.get_Id()),e.Attr().Class("col-sm-2 control-label"),e.Text("Password")]);return l.add(e.Div(f.ofArray([e.Attr().Class("form-horizontal container"),e.Attr().NewAttr("style","margin-top: 2em; width: 50%; min-width: 200px")])),f.ofArray([l.add(e.Div(f.ofArray([e.Attr().Class("form-group")])),f.ofArray([e.Tags().NewTag("label",bq),l.add(e.Div(f.ofArray([e.Attr().Class("col-sm-10")])),f.ofArray([bi]))])),l.add(e.Div(f.ofArray([e.Attr().Class("form-group")])),f.ofArray([e.Tags().NewTag("label",br),l.add(e.Div(f.ofArray([e.Attr().Class("col-sm-10")])),f.ofArray([bl]))])),l.add(e.Div(f.ofArray([e.Attr().Class("form-group")])),f.ofArray([l.add(e.Div(f.ofArray([e.Attr().Class("col-sm-offset-2 col-sm-10")])),f.ofArray([bo]))])),x.ShowErrors(bh,function(bs){return f.map(function(bt){return l.add(e.P(f.ofArray([e.Attr().NewAttr("style","color: red")])),f.ofArray([e.Text(bt)]));},bs);},e.Div(f.ofArray([e.Attr().NewAttr("id","errors")])))]));}},LoginControl:$.Class({get_Body:function(){return r.LoginForm(this.redirectUrl);}})}});$.OnInit(function(){a=$.Safe($$.document);b=$.Safe($$.jQuery);c=$.Safe($$.IntelliFactory.WebSharper);d=$.Safe(c.Html);e=$.Safe(d.Default);f=$.Safe(c.List);g=$.Safe($$.WebsharperChat);h=$.Safe(g.ChatClient);i=$.Safe($$.WebSocket);j=$.Safe($$.window);k=$.Safe(d.EventsPervasives);l=$.Safe(d.Operators);m=$.Safe(c.JavaScript);n=$.Safe(c.Arrays);o=$.Safe(c.Strings);p=$.Safe($$.JSON);q=$.Safe($$.String);r=$.Safe(g.ClAuth);s=$.Safe(c.Piglets);t=$.Safe(s.Piglet1);u=$.Safe(s.Pervasives);v=$.Safe(t.Validation);w=$.Safe(c.Remoting);return x=$.Safe(s.Controls);});$.OnLoad(function(){r.LoginPiglet();return;});}());

(function(){var $$=this,$=this.IntelliFactory.Runtime,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;$.Define($$,{WebsharperChat:{ChatClient:{Append:function(y){var z;z=a.getElementById("chatbox").appendChild(y.Body).parentNode;b(z).scrollTop(b(z).height());return;},AppendUser:function(A){var B;B=e.LI(f.ofArray([e.Text(A)]));a.getElementById("usrli").appendChild(B.Body);return;},Connect:function(C){return h.SetEventHandlers(new i(C));},HandleMessage:function(D){var E,F;if(D.$==0){return h.Append(h.RenderMsg(D.$0,D.$1));}else{if(D.$==2){return h.ShowUserList(h.RenderUserlist(D.$0));}else{if(D.$==3){if(D.$0){E=D.$1;h.Append(h.RenderInfo(E+" has connected"));return h.AppendUser(E);}else{F=D.$1;h.Append(h.RenderInfo(F+" has disconnected"));return h.RemoveUser(F);}}else{return h.Append(h.RenderError(D.$0));}}}},Main:function(G){var H,I,J;H=h.Connect("ws://"+j.location.host+"/chatsocket");I=e.Input(f.ofArray([e.Text(""),e.Attr().NewAttr("id","message-box"),e.Attr().Class("form-control col-md-12"),e.Attr().NewAttr("type","text")]));J=function(){return function(L){return L.CharacterCode===13?h.SendText(H,I):null;};};k.Events().OnKeyPress(J,I);return l.add(e.Div(f.ofArray([e.Attr().Class("container")])),f.ofArray([e.A(f.ofArray([e.Attr().NewAttr("href",G),e.Attr().Class("btn btn-primary"),e.Text("Log out")])),l.add(e.Div(f.ofArray([e.Attr().Class("row styled_container")])),f.ofArray([e.Div(f.ofArray([e.Attr().NewAttr("id","chatbox"),e.Attr().Class("col-md-10")])),e.Div(f.ofArray([e.Attr().NewAttr("id","userlist"),e.Attr().Class("col-md-2")]))])),l.add(e.Div(f.ofArray([e.Attr().Class("row")])),f.ofArray([I]))]));},RemoveUser:function(M){b("#userli").each(function(){var O;O=b(this);return O.text()===M?void O.remove():null;});},RenderError:function(P){return e.P(f.ofArray([e.Text(P),e.Attr().Class("bg-danger")]));},RenderInfo:function(Q){return e.P(f.ofArray([e.Text(Q),e.Attr().Class("bg-warning")]));},RenderMsg:function(R,S){var T;T=f.ofArray([e.Text(R+": ")]);return l.add(e.P(f.ofArray([e.Tags().NewTag("strong",T)])),f.ofArray([e.Text(S),e.Attr().Class("bg-info")]));},RenderUserlist:function(U){return l.add(e.UL(f.ofArray([e.Attr().NewAttr("id","userli")])),m.map(function(V){return e.LI(f.ofArray([e.Text(V)]));},U));},SendText:function(W,X){var Y;Y=n.Trim(X.get_Value());if(Y!==""){W.send(Y);}return X.set_Value("");},SetEventHandlers:function(Z){Z.onmessage=function(_0){return h.HandleMessage(o.parse(p(_0.data)));};Z.onerror=function(){return h.Append(h.RenderError("Something went wrong."));};return Z;},ShowUserList:function(_2){var _3;_3=b("#userlist");_3.children().each(function(){b(this).remove();});_3.append(_2.Body);return;}},ChatControl:$.Class({get_Body:function(){return h.Main(this.logout);}}),ClAuth:{LoginForm:function(_5){return r.Render(function(_6){return function(_7){return function(_8){return s.RenderLoginForm(_6,_7,_8);};};},r.Run(function(){j.location=_5;return _5;},s.LoginPiglet()));},LoginPiglet:$.Field(function(){return r.WithSubmit(t.Is(function(_){return _;},"Invalid username or password",u.op_LessMultiplyGreater(u.op_LessMultiplyGreater(r.Return(function(ba){return function(bb){return v.Call("WebsharperChat:0",[ba,bb]);};}),t.Is(function(bb){return t.NotEmpty(bb);},"Enter Username",r.Yield(""))),t.Is(function(bc){return t.NotEmpty(bc);},"Enter password",r.Yield("")))));}),RenderLoginForm:function(bd,be,bf){var bg,bj,bm,bo,bp;bg=w.input("text",function(bh){return bh;},function(bi){return bi;},bd);bg["HtmlProvider@32"].AddClass(bg.Body,"form-control");bj=w.input("text",function(bk){return bk;},function(bl){return bl;},be);bj["HtmlProvider@32"].AddClass(bj.Body,"form-control");bj["HtmlProvider@32"].SetAttribute(bj.Body,"type","password");bm=w.Submit(bf);bm["HtmlProvider@32"].AddClass(bm.Body,"btn btn-primary");b(bj.Body).keyup(function(bn){if(bn.which===13){bn.preventDefault();b(bm.Body).click();return;}else{return null;}});bo=f.ofArray([e.Attr().NewAttr("for",bg.get_Id()),e.Attr().Class("col-sm-2 control-label"),e.Text("Username")]);bp=f.ofArray([e.Attr().NewAttr("for",bj.get_Id()),e.Attr().Class("col-sm-2 control-label"),e.Text("Password")]);return l.add(e.Div(f.ofArray([e.Attr().Class("form-horizontal container"),e.Attr().NewAttr("style","margin-top: 2em; width: 50%; min-width: 200px")])),f.ofArray([l.add(e.Div(f.ofArray([e.Attr().Class("form-group")])),f.ofArray([e.Tags().NewTag("label",bo),l.add(e.Div(f.ofArray([e.Attr().Class("col-sm-10")])),f.ofArray([bg]))])),l.add(e.Div(f.ofArray([e.Attr().Class("form-group")])),f.ofArray([e.Tags().NewTag("label",bp),l.add(e.Div(f.ofArray([e.Attr().Class("col-sm-10")])),f.ofArray([bj]))])),l.add(e.Div(f.ofArray([e.Attr().Class("form-group")])),f.ofArray([l.add(e.Div(f.ofArray([e.Attr().Class("col-sm-offset-2 col-sm-10")])),f.ofArray([bm]))])),w.ShowErrors(bf,function(bq){return f.map(function(br){return l.add(e.P(f.ofArray([e.Attr().NewAttr("style","color: red")])),f.ofArray([e.Text(br)]));},bq);},e.Div($.New(x,{$:0})))]));}},LoginControl:$.Class({get_Body:function(){return s.LoginForm(this.redirectUrl);}})}});$.OnInit(function(){a=$.Safe($$.document);b=$.Safe($$.jQuery);c=$.Safe($$.IntelliFactory.WebSharper);d=$.Safe(c.Html);e=$.Safe(d.Default);f=$.Safe(c.List);g=$.Safe($$.WebsharperChat);h=$.Safe(g.ChatClient);i=$.Safe($$.WebSocket);j=$.Safe($$.window);k=$.Safe(d.EventsPervasives);l=$.Safe(d.Operators);m=$.Safe(c.Arrays);n=$.Safe(c.Strings);o=$.Safe($$.JSON);p=$.Safe($$.String);q=$.Safe(c.Piglets);r=$.Safe(q.Piglet1);s=$.Safe(g.ClAuth);t=$.Safe(r.Validation);u=$.Safe(q.Pervasives);v=$.Safe(c.Remoting);w=$.Safe(q.Controls);return x=$.Safe(f.T);});$.OnLoad(function(){s.LoginPiglet();return;});}());
